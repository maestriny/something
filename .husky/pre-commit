#!/usr/bin/env sh

YELLOW='\033[33m'
RED='\033[31m'
GREEN='\033[32m'
NC='\033[0m'

echo "${YELLOW}Running pre-commit checks...${NC}"

npx lint-staged || {
  echo "${RED}Linting failed. Please fix the issues before committing.${NC}"
  exit 1
}

npx tsc --noEmit || {
  echo "${RED}TypeScript found some issues. Please fix them before committing.${NC}"
  exit 1
}

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | grep -v 'eslint\.config')
if [ -n "$STAGED_FILES" ]; then
  VIOLATIONS=$(echo "$STAGED_FILES" | xargs git diff --cached | awk '
    /^\+.*eslint-disable/ { prev_disabled=1; next }
    /^\+.*console\.log|^\+.*debugger/ {
      if (!prev_disabled) print;
      prev_disabled=0;
      next
    }
    { prev_disabled=0 }
  ')
  if [ -n "$VIOLATIONS" ]; then
    echo "${RED}Found 'console.log' or 'debugger' in staged changes. Please remove them.${NC}"
    exit 1
  fi
fi

echo "${GREEN}Your code is pipeline-proof. It's now safe to push â™¡${NC}"
exit 0
